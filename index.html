<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Skills Trainer - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
        }

        h2 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #333;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 25px;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .room-code-display {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .room-code {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 3px;
        }

        .room-code-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .player-list {
            margin: 20px 0;
        }

        .player-item {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: 600;
        }

        .host-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .scenario-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .timer-container {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .timer-display.warning {
            color: #f59e0b;
        }

        .timer-display.danger {
            color: #ef4444;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }

        .timer-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #667eea 100%);
            transition: width 0.1s linear;
        }

        .timer-bar-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #f59e0b 100%);
        }

        .timer-bar-fill.danger {
            background: linear-gradient(90deg, #ef4444 0%, #ef4444 100%);
        }

        .points-indicator {
            font-size: 14px;
            color: #6b7280;
            margin-top: 8px;
        }

        .scenario-type {
            display: inline-block;
            background: #ede9fe;
            color: #7c3aed;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .customer-speech {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 25px;
        }

        .customer-speech p {
            font-size: 18px;
            line-height: 1.6;
            color: #333;
        }

        .customer-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .question {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 18px;
            border-radius: 10px;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .option-btn:hover:not(:disabled) {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        .option-btn.correct {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .option-btn.incorrect {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .scoreboard {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .scoreboard-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .score-item.current-player {
            background: #ede9fe;
            border: 2px solid #667eea;
        }

        .player-score {
            font-weight: bold;
            color: #667eea;
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }

        .feedback.incorrect {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .feedback-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .points-earned {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }

        .countdown {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
        }

        .waiting-message {
            text-align: center;
            color: #6b7280;
            padding: 20px;
            font-style: italic;
        }

        .final-results {
            background: white;
            padding: 30px;
            border-radius: 15px;
        }

        .winner-announcement {
            text-align: center;
            margin-bottom: 30px;
        }

        .winner-announcement h2 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .progress-indicator {
            text-align: center;
            margin: 15px 0;
            color: #6b7280;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Username Entry Screen -->
        <div class="screen active" id="username-screen">
            <div class="card">
                <h1>Sales Skills Trainer</h1>
                <p class="subtitle">Multiplayer Objection Handling</p>
                <input type="text" id="username-input" placeholder="Enter your name" maxlength="20">
                <button class="btn-primary" id="username-btn">Continue</button>
            </div>
        </div>

        <!-- Menu Screen -->
        <div class="screen" id="menu-screen">
            <div class="card">
                <h1>Welcome, <span id="display-username"></span>!</h1>
                <p class="subtitle">Ready to practice sales skills?</p>
                <button class="btn-primary" id="create-room-btn">Create New Game</button>
                <button class="btn-secondary" id="show-join-btn">Join Existing Game</button>
            </div>
        </div>

        <!-- Join Room Screen -->
        <div class="screen" id="join-screen">
            <div class="card">
                <h2>Join Game</h2>
                <input type="text" id="room-code-input" placeholder="Enter room code" maxlength="6" style="text-transform: uppercase;">
                <button class="btn-primary" id="join-room-btn">Join Game</button>
                <button class="btn-secondary" id="back-to-menu-btn">Back</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div class="screen" id="lobby-screen">
            <div class="card">
                <h2>Game Lobby</h2>
                <div class="room-code-display">
                    <div class="room-code-label">Room Code</div>
                    <div class="room-code" id="lobby-room-code"></div>
                </div>
                <div class="player-list">
                    <h3 style="margin-bottom: 15px;">Players (<span id="player-count">0</span>)</h3>
                    <div id="players-container"></div>
                </div>
                <button class="btn-primary" id="start-game-btn" style="display: none;">Start Game</button>
                <div class="waiting-message" id="waiting-message" style="display: none;">
                    Waiting for host to start the game...
                </div>
                <button class="btn-secondary" id="leave-room-btn">Leave Room</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="game-screen">
            <div class="scoreboard">
                <div class="scoreboard-title">Live Scores</div>
                <div id="live-scoreboard"></div>
            </div>

            <div class="timer-container" id="timer-container">
                <div class="timer-display" id="timer-display">30</div>
                <div class="timer-bar">
                    <div class="timer-bar-fill" id="timer-bar-fill" style="width: 100%"></div>
                </div>
                <div class="points-indicator" id="points-indicator">Answer now for 1000 points!</div>
            </div>

            <div class="scenario-card">
                <div class="progress-indicator">
                    Question <span id="question-number">1</span> of <span id="total-questions">10</span>
                </div>
                
                <span class="scenario-type" id="scenario-type"></span>
                
                <div class="customer-speech">
                    <div class="customer-label">Customer says:</div>
                    <p id="customer-text"></p>
                </div>

                <div class="question">How do you respond?</div>

                <div class="options" id="game-options"></div>

                <div class="feedback" id="game-feedback">
                    <div class="feedback-title" id="game-feedback-title"></div>
                    <div class="points-earned" id="points-earned" style="display: none;"></div>
                    <p id="game-feedback-text"></p>
                </div>

                <div id="waiting-next" class="waiting-message" style="display: none;">
                    Waiting for other players...
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="results-screen">
            <div class="final-results">
                <div class="winner-announcement">
                    <h2>üèÜ Game Complete!</h2>
                    <p class="subtitle">Final Results</p>
                </div>
                <div id="final-scoreboard"></div>
                <button class="btn-primary" id="back-to-menu-final-btn" style="margin-top: 20px;">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, update, onValue, push, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBpwmaHVupoJjoFIVvTU9sfVWbqFiyJW4E",
            authDomain: "sales-training-multi-player.firebaseapp.com",
            databaseURL: "https://sales-training-multi-player-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sales-training-multi-player",
            storageBucket: "sales-training-multi-player.firebasestorage.app",
            messagingSenderId: "995011237067",
            appId: "1:995011237067:web:28bda644104401d285774e"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Game scenarios (using your custom ETF/Managed Funds scenarios)
        const scenarios = [
            {
                type: "Fee Objection",
                customerText: "Your management fees are higher than passive index ETFs. Why should my clients pay more?",
                options: [
                    { text: "You're right, let me see if I can get you a fee discount.", correct: false },
                    { text: "I understand fee sensitivity is crucial when advising clients. Can we look at the total value proposition? Our active management has outperformed the index by X% over 3 years, and when you factor in our research support and portfolio construction tools for advisers, what's the total cost of ownership versus total value delivered?", correct: true },
                    { text: "Passive funds are just beta exposure. You get what you pay for with active management.", correct: false },
                    { text: "Our fees are competitive within the active management space.", correct: false }
                ],
                correctFeedback: "Excellent! You've shifted from price to value, quantified outperformance, and highlighted the additional adviser support tools. You're helping them see the complete picture beyond just the management fee.",
                incorrectFeedback: "Don't immediately discount or get defensive about active vs passive. Show the complete value - performance net of fees, research support, and how it helps them serve their clients better."
            },
            {
                type: "Platform Availability",
                customerText: "Your fund isn't on our platform. It's too much hassle to add new fund managers.",
                options: [
                    { text: "I understand. Which platform are you on? Let me check our current status and see what we can do.", correct: true },
                    { text: "We're working on getting listed on all major platforms. Can I follow up in a few months?", correct: false },
                    { text: "Actually, adding a new manager is straightforward - I can walk you through the process.", correct: false },
                    { text: "Many advisers use our fund despite platform limitations because the performance justifies it.", correct: false }
                ],
                correctFeedback: "Perfect! You're gathering information first. This lets you check if you're already on their platform, understand the timeline for approval, or explore if they use multiple platforms. You're problem-solving rather than dismissing their concern.",
                incorrectFeedback: "Don't assume the barrier is insurmountable or minimize their concern. Understand their specific platform situation first - you might already be accessible to them, or you can work with your internal team on fast-tracking approval."
            },
            {
                type: "Performance Track Record",
                customerText: "Your fund has only been running for 18 months. My clients need a longer track record.",
                options: [
                    { text: "That's fair. What timeline would make you comfortable? I can show you the portfolio manager's 10-year track record at their previous firm managing a similar strategy.", correct: true },
                    { text: "18 months is enough to see our investment process working. Look at our recent performance.", correct: false },
                    { text: "Track record isn't everything - our investment team has decades of combined experience.", correct: false },
                    { text: "I understand. Can I stay in touch and we'll reconnect when we have 3 years?", correct: false }
                ],
                correctFeedback: "Great work! You're acknowledging their valid concern while bridging to the portfolio manager's longer track record and similar strategy experience. This addresses the underlying need for proven capability while respecting the new fund timeline.",
                incorrectFeedback: "Don't dismiss the importance of track record or just wait. Show the continuity of the investment approach through the manager's history, similar strategies, or the team's pedigree. Address the substance of their concern."
            },
            {
                type: "Existing Manager Relationship",
                customerText: "We already use a competitor for this asset class. Our clients are happy with them.",
                options: [
                    { text: "That's great they're working well. Out of curiosity, if you were to consider a complementary or alternative approach in this space, what would need to be different or better?", correct: true },
                    { text: "Let me show you our head-to-head performance comparison. We've beaten them over 1, 3, and 5 years.", correct: false },
                    { text: "They're a solid choice. Maybe we could work together on a different asset class?", correct: false },
                    { text: "Have you done a recent portfolio review? Market conditions have changed.", correct: false }
                ],
                correctFeedback: "Excellent! You're respecting the existing relationship while exploring if there's an opening for diversification, different style exposure, or specific gaps. This is consultative rather than confrontational.",
                incorrectFeedback: "Don't attack the incumbent or retreat entirely. Understand what would make them consider an alternative - different investment style, risk profile, or specific client needs - then position accordingly."
            },
            {
                type: "Research Coverage",
                customerText: "I need to complete due diligence before I can recommend this to clients. I don't have time right now.",
                options: [
                    { text: "I completely understand - due diligence is critical. What's your typical DD process? I can provide our standard materials upfront and then we can schedule a focused session when you have capacity to review properly.", correct: true },
                    { text: "Our research team can do a call next week to answer all your questions.", correct: false },
                    { text: "Due diligence doesn't have to be time-consuming. I can give you the executive summary.", correct: false },
                    { text: "No problem. When would be a better time? I'll follow up then.", correct: false }
                ],
                correctFeedback: "Perfect! You're respecting their process, making it easier for them by understanding what they need, and setting up for a productive conversation when they're ready. You're reducing friction rather than adding pressure.",
                incorrectFeedback: "Don't minimize the importance of DD or just defer. Understand their process and proactively provide what they need to make their job easier when they have time to focus on it."
            },
            {
                type: "Client Suitability",
                customerText: "I'm not sure this fund suits my client base. They're mostly conservative retirees.",
                options: [
                    { text: "Tell me more about your typical client - their risk tolerance, income needs, and current portfolio allocation. Let's see if and where this might fit, or if it's genuinely not a match.", correct: true },
                    { text: "This fund is actually perfect for conservative clients - low volatility and consistent income.", correct: false },
                    { text: "You might be surprised. Let me show you the risk metrics compared to balanced funds.", correct: false },
                    { text: "That's fair. Would you have clients with different profiles where this might work?", correct: false }
                ],
                correctFeedback: "Excellent! You're digging into their client base specifics rather than making assumptions. This might reveal it's genuinely not a fit, or you might uncover a subset of clients or a portfolio role that makes sense. Either way, you're being consultative.",
                incorrectFeedback: "Don't force fit or make generic claims. Understand their clients' actual needs and circumstances, then honestly assess fit. Being selective builds trust and might reveal opportunities you hadn't considered."
            },
            {
                type: "Compliance Concerns",
                customerText: "Our compliance team has strict APL requirements. Getting new funds approved takes months.",
                options: [
                    { text: "I work with many practices with similar compliance processes. What specific documentation or criteria does your compliance team require? I can provide everything upfront to streamline the process.", correct: true },
                    { text: "Most compliance teams approve us quickly once they see our materials.", correct: false },
                    { text: "That seems excessive. Have you pushed back on that timeline?", correct: false },
                    { text: "I understand. Shall I check back in 6 months?", correct: false }
                ],
                correctFeedback: "Great approach! You're showing experience with compliance processes, taking ownership of making it easier, and demonstrating you can navigate their specific requirements. This positions you as a partner, not another hurdle.",
                incorrectFeedback: "Don't dismiss their compliance requirements or just wait passively. Understand what's needed, provide it proactively, and show you've helped other advisers navigate similar processes successfully."
            },
            {
                type: "Market Timing",
                customerText: "With markets at all-time highs, now isn't the right time to be putting client money into equities.",
                options: [
                    { text: "I hear that concern about valuations. What's your current thinking on portfolio positioning? Are you looking at tactical opportunities, or is this more about your clients' long-term strategic allocations?", correct: true },
                    { text: "Market timing is notoriously difficult. Time in the market beats timing the market.", correct: false },
                    { text: "That's exactly why active management matters - we can be selective in this environment.", correct: false },
                    { text: "You're right to be cautious. When do you think would be a better entry point?", correct: false }
                ],
                correctFeedback: "Perfect! You're understanding their investment philosophy and client positioning strategy rather than debating market timing. This helps you understand if they're tactical (maybe there's an opportunity) or strategic (different conversation about long-term allocation).",
                incorrectFeedback: "Don't lecture about market timing or concede their timing concerns. Understand their broader portfolio construction approach and client objectives - that's where the real conversation is."
            },
            {
                type: "Documentation Requirements",
                customerText: "I need detailed fact sheets, PDS, and research reports before I can even look at this.",
                options: [
                    { text: "Absolutely. I'll send everything over today. Beyond the standard docs, is there specific information that's most important for your initial assessment - performance attribution, portfolio positioning, team bios?", correct: true },
                    { text: "Of course, I'll email you our complete information pack right away.", correct: false },
                    { text: "All of that is available on our website. I can send you the link.", correct: false },
                    { text: "I have everything here. Can we schedule 30 minutes to walk through it together?", correct: false }
                ],
                correctFeedback: "Excellent! You're providing what they need immediately while also understanding what matters most to them. This lets you prioritize and potentially flag the most relevant materials, making their review more efficient.",
                incorrectFeedback: "Don't just send generic materials or push for a meeting. Provide what they need and understand their decision criteria so you can help them focus on what matters most."
            },
            {
                type: "Benchmark Comparison",
                customerText: "You've underperformed your benchmark in 3 of the last 5 years. How do I explain that to clients?",
                options: [
                    { text: "Let's look at the full context. What matters most to your clients - calendar year performance or risk-adjusted returns over a full cycle? Our approach prioritizes capital preservation in down markets, which means we might lag in strong up years but protect better in corrections. Over the full 5 years, here's our risk-return profile versus the benchmark.", correct: true },
                    { text: "Active managers can have periods of underperformance. What matters is the long-term.", correct: false },
                    { text: "Our benchmark isn't really appropriate for our strategy. We should use a different comparison.", correct: false },
                    { text: "Those underperforming years were market-driven, not fund management issues.", correct: false }
                ],
                correctFeedback: "Perfect! You're reframing the conversation to what actually matters to their clients - risk-adjusted returns and the role this plays in a portfolio. You're acknowledging the underperformance while providing context about the investment philosophy and trade-offs.",
                incorrectFeedback: "Don't make excuses or dismiss the concern. Address it directly with context about the strategy's objectives, risk management, and how that serves client needs. Help them articulate the value to their clients."
            }
        ];

        // Timer configuration
        const QUESTION_TIME_LIMIT = 30; // seconds
        const MAX_POINTS = 1000;
        
        // Global state
        let currentUser = null;
        let currentRoom = null;
        let isHost = false;
        let timerInterval = null;
        let questionStartTime = null;

        // Show/hide screens
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Calculate points based on time remaining
        function calculatePoints(secondsRemaining) {
            // Linear decay from 1000 to 100 points
            const minPoints = 100;
            const pointsPerSecond = (MAX_POINTS - minPoints) / QUESTION_TIME_LIMIT;
            return Math.max(minPoints, Math.round(MAX_POINTS - (QUESTION_TIME_LIMIT - secondsRemaining) * pointsPerSecond));
        }

        // Start timer for question
        function startQuestionTimer() {
            questionStartTime = Date.now();
            let timeLeft = QUESTION_TIME_LIMIT;
            
            const timerDisplay = document.getElementById('timer-display');
            const timerBarFill = document.getElementById('timer-bar-fill');
            const pointsIndicator = document.getElementById('points-indicator');
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                timeLeft = QUESTION_TIME_LIMIT - elapsed;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeLeft = 0;
                    // Auto-submit as wrong answer if time runs out
                    autoSubmitTimeout();
                }
                
                // Update display
                timerDisplay.textContent = timeLeft;
                const percentage = (timeLeft / QUESTION_TIME_LIMIT) * 100;
                timerBarFill.style.width = percentage + '%';
                
                // Update points indicator
                const currentPoints = calculatePoints(timeLeft);
                pointsIndicator.textContent = `Answer now for ${currentPoints} points!`;
                
                // Color coding
                timerDisplay.classList.remove('warning', 'danger');
                timerBarFill.classList.remove('warning', 'danger');
                
                if (timeLeft <= 5) {
                    timerDisplay.classList.add('danger');
                    timerBarFill.classList.add('danger');
                } else if (timeLeft <= 10) {
                    timerDisplay.classList.add('warning');
                    timerBarFill.classList.add('warning');
                }
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        async function autoSubmitTimeout() {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
            });

            await update(ref(database, `rooms/${currentRoom}/players/${currentUser.id}`), {
                answered: true,
                score: (await get(ref(database, `rooms/${currentRoom}/players/${currentUser.id}/score`))).val() || 0
            });

            const feedback = document.getElementById('game-feedback');
            feedback.classList.add('show', 'incorrect');
            document.getElementById('game-feedback-title').textContent = '‚è∞ Time\'s Up!';
            document.getElementById('game-feedback-text').textContent = 'You ran out of time. No points awarded for this question.';
            document.getElementById('points-earned').style.display = 'none';
            document.getElementById('waiting-next').style.display = 'block';
            document.getElementById('timer-container').style.display = 'none';
        }

        // Event Listeners
        document.getElementById('username-btn').addEventListener('click', function() {
            const username = document.getElementById('username-input').value.trim();
            if (username) {
                currentUser = {
                    id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: username
                };
                document.getElementById('display-username').textContent = username;
                showScreen('menu-screen');
            } else {
                alert('Please enter your name');
            }
        });

        document.getElementById('username-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('username-btn').click();
            }
        });

        document.getElementById('create-room-btn').addEventListener('click', createRoom);
        document.getElementById('show-join-btn').addEventListener('click', function() {
            showScreen('join-screen');
        });
        document.getElementById('join-room-btn').addEventListener('click', joinRoom);
        document.getElementById('back-to-menu-btn').addEventListener('click', function() {
            showScreen('menu-screen');
        });
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        document.getElementById('leave-room-btn').addEventListener('click', leaveRoom);
        document.getElementById('back-to-menu-final-btn').addEventListener('click', backToMenu);

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        async function createRoom() {
            const roomCode = generateRoomCode();
            currentRoom = roomCode;
            isHost = true;

            const shuffled = [...scenarios].sort(() => Math.random() - 0.5);

            const roomData = {
                host: currentUser.id,
                status: 'lobby',
                createdAt: Date.now(),
                scenarios: shuffled,
                currentQuestion: 0,
                players: {
                    [currentUser.id]: {
                        name: currentUser.name,
                        score: 0,
                        answered: false,
                        isHost: true
                    }
                }
            };

            await set(ref(database, `rooms/${roomCode}`), roomData);

            const playerRef = ref(database, `rooms/${roomCode}/players/${currentUser.id}`);
            onDisconnect(playerRef).remove();

            listenToRoom(roomCode);
            showScreen('lobby-screen');
        }

        async function joinRoom() {
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!roomCode) {
                alert('Please enter a room code');
                return;
            }

            const roomRef = ref(database, `rooms/${roomCode}`);
            const snapshot = await get(roomRef);

            if (!snapshot.exists()) {
                alert('Room not found');
                return;
            }

            const roomData = snapshot.val();
            if (roomData.status !== 'lobby') {
                alert('Game already in progress');
                return;
            }

            currentRoom = roomCode;
            isHost = false;

            await update(ref(database, `rooms/${roomCode}/players/${currentUser.id}`), {
                name: currentUser.name,
                score: 0,
                answered: false,
                isHost: false
            });

            const playerRef = ref(database, `rooms/${roomCode}/players/${currentUser.id}`);
            onDisconnect(playerRef).remove();

            listenToRoom(roomCode);
            showScreen('lobby-screen');
        }

        function listenToRoom(roomCode) {
            const roomRef = ref(database, `rooms/${roomCode}`);
            onValue(roomRef, (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Room has been closed');
                    backToMenu();
                    return;
                }

                const roomData = snapshot.val();
                updateLobby(roomData);

                if (roomData.status === 'playing') {
                    updateGameScreen(roomData);
                } else if (roomData.status === 'finished') {
                    showResults(roomData);
                }
            });
        }

        function updateLobby(roomData) {
            document.getElementById('lobby-room-code').textContent = currentRoom;
            
            const players = Object.values(roomData.players || {});
            document.getElementById('player-count').textContent = players.length;

            const container = document.getElementById('players-container');
            container.innerHTML = players.map(player => `
                <div class="player-item">
                    <span class="player-name">${player.name}</span>
                    ${player.isHost ? '<span class="host-badge">Host</span>' : ''}
                </div>
            `).join('');

            if (isHost) {
                document.getElementById('start-game-btn').style.display = 'block';
                document.getElementById('waiting-message').style.display = 'none';
            } else {
                document.getElementById('start-game-btn').style.display = 'none';
                document.getElementById('waiting-message').style.display = 'block';
            }
        }

        async function startGame() {
            await update(ref(database, `rooms/${currentRoom}`), {
                status: 'playing',
                currentQuestion: 0
            });
            showScreen('game-screen');
        }

        function updateGameScreen(roomData) {
            if (roomData.status !== 'playing') return;

            showScreen('game-screen');

            const currentQ = roomData.currentQuestion;
            const scenario = roomData.scenarios[currentQ];

            document.getElementById('question-number').textContent = currentQ + 1;
            document.getElementById('total-questions').textContent = roomData.scenarios.length;
            document.getElementById('scenario-type').textContent = scenario.type;
            document.getElementById('customer-text').textContent = scenario.customerText;

            updateScoreboard(roomData.players);

            const playerData = roomData.players[currentUser.id];
            if (!playerData.answered) {
                showOptions(scenario, roomData);
            } else {
                document.getElementById('waiting-next').style.display = 'block';
                document.getElementById('timer-container').style.display = 'none';
            }

            const allAnswered = Object.values(roomData.players).every(p => p.answered);
            if (allAnswered && isHost) {
                setTimeout(() => {
                    nextQuestion(roomData);
                }, 3000);
            }
        }

        function showOptions(scenario, roomData) {
            const container = document.getElementById('game-options');
            container.innerHTML = '';
            
            scenario.options.forEach((option, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.addEventListener('click', () => answerQuestion(i, option.correct, scenario));
                container.appendChild(btn);
            });

            document.getElementById('game-feedback').classList.remove('show', 'correct', 'incorrect');
            document.getElementById('waiting-next').style.display = 'none';
            document.getElementById('timer-container').style.display = 'block';
            
            // Start the timer
            startQuestionTimer();
        }

        async function answerQuestion(index, isCorrect, scenario) {
            stopTimer();
            
            const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
            const timeRemaining = Math.max(0, QUESTION_TIME_LIMIT - elapsed);
            const pointsEarned = isCorrect ? calculatePoints(timeRemaining) : 0;

            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                if (scenario.options[i].correct) {
                    btn.classList.add('correct');
                }
            });

            if (!isCorrect) {
                buttons[index].classList.add('incorrect');
            }

            const currentScoreSnapshot = await get(ref(database, `rooms/${currentRoom}/players/${currentUser.id}/score`));
            const currentScore = currentScoreSnapshot.val() || 0;
            
            await update(ref(database, `rooms/${currentRoom}/players/${currentUser.id}`), {
                answered: true,
                score: currentScore + pointsEarned
            });

            const feedback = document.getElementById('game-feedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'incorrect');
            document.getElementById('game-feedback-title').textContent = isCorrect ? 'üéâ Excellent!' : 'üí° Learning Moment';
            
            const pointsEarnedElement = document.getElementById('points-earned');
            if (isCorrect) {
                pointsEarnedElement.textContent = `+${pointsEarned} points`;
                pointsEarnedElement.style.display = 'inline-block';
            } else {
                pointsEarnedElement.style.display = 'none';
            }
            
            document.getElementById('game-feedback-text').textContent = isCorrect ? scenario.correctFeedback : scenario.incorrectFeedback;

            document.getElementById('waiting-next').style.display = 'block';
            document.getElementById('timer-container').style.display = 'none';
        }

        async function nextQuestion(roomData) {
            const nextQ = roomData.currentQuestion + 1;
            
            if (nextQ >= roomData.scenarios.length) {
                await update(ref(database, `rooms/${currentRoom}`), {
                    status: 'finished'
                });
            } else {
                const updates = {};
                Object.keys(roomData.players).forEach(playerId => {
                    updates[`rooms/${currentRoom}/players/${playerId}/answered`] = false;
                });
                updates[`rooms/${currentRoom}/currentQuestion`] = nextQ;
                
                await update(ref(database), updates);
            }
        }

        function updateScoreboard(players) {
            const sorted = Object.entries(players).sort((a, b) => b[1].score - a[1].score);
            const html = sorted.map(([id, player]) => `
                <div class="score-item ${id === currentUser.id ? 'current-player' : ''}">
                    <span>${player.name}</span>
                    <span class="player-score">${player.score.toLocaleString()} pts</span>
                </div>
            `).join('');
            document.getElementById('live-scoreboard').innerHTML = html;
        }

        function showResults(roomData) {
            stopTimer();
            showScreen('results-screen');
            
            const sorted = Object.entries(roomData.players).sort((a, b) => b[1].score - a[1].score);
            const html = sorted.map(([id, player], index) => `
                <div class="score-item ${id === currentUser.id ? 'current-player' : ''}">
                    <span>${index + 1}. ${player.name}</span>
                    <span class="player-score">${player.score.toLocaleString()} pts</span>
                </div>
            `).join('');
            document.getElementById('final-scoreboard').innerHTML = html;
        }

        async function leaveRoom() {
            stopTimer();
            if (currentRoom) {
                await remove(ref(database, `rooms/${currentRoom}/players/${currentUser.id}`));
                currentRoom = null;
                isHost = false;
            }
            showScreen('menu-screen');
        }

        function backToMenu() {
            stopTimer();
            currentRoom = null;
            isHost = false;
            showScreen('menu-screen');
        }
    </script>
</body>
</html>
